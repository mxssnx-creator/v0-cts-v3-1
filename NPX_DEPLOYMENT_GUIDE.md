# NPX Deployment Guide for CTS v3.1

## Overview

This guide covers deploying CTS v3.1 using npx commands for quick installation and component management.

## Prerequisites

- Node.js 18.x - 26.x
- npm 8.0.0 or higher
- Ubuntu 20.04+ (for production nginx setup)
- PostgreSQL 13+ (optional, SQLite is default)

---

## Quick Start with NPX

### Option 1: Direct NPX Installation

```bash
# Install CTS directly with npx
npx create-cts-app my-trading-system

# Or use the repository directly
npx github:your-username/cts-v3.1 setup
```

### Option 2: Clone and Use NPX Scripts

```bash
# Clone repository
git clone https://github.com/your-repo/cts-v3.1.git
cd cts-v3.1

# Run setup via npx (no install needed)
npx . setup

# Or use npm scripts
npm install
npm run setup
```

---

## NPX Commands

### Setup Commands

```bash
# Interactive setup wizard
npx . setup
# Prompts for:
# - Project name (default: CTS-v3)
# - Port (default: 3000)  
# - Database type (SQLite/PostgreSQL)
# - Auto-generates secure secrets

# Quick setup with defaults
npx . setup --defaults

# Custom setup
npx . setup --name my-bot --port 8080 --db postgresql
```

### Development Commands

```bash
# Start development server
npm run dev

# With custom port
PORT=8080 npm run dev

# Type checking
npm run type-check

# Linting
npm run lint
```

### Database Commands

```bash
# Run migrations
npm run db:migrate

# Check database status
npm run db:status

# Reset database (caution!)
npm run db:reset

# Backup database
npm run db:backup
```

### Build & Deploy

```bash
# Build for production
npm run build

# Start production server
npm start

# Or with PM2
pm2 start npm --name "cts-v3" -- start

# Deploy to Vercel
vercel --prod
```

### System Management

```bash
# System health check
npm run system:check

# Quick health check
npm run system:health

# Clear caches
npm run clean

# Full clean reinstall
npm run clean:all
```

### Nginx & SSL (Ubuntu/Debian)

```bash
# Setup nginx reverse proxy
npm run nginx:setup

# Restart nginx
npm run nginx:restart

# Check nginx status
npm run nginx:status

# View nginx logs
npm run nginx:logs

# Install SSL certificates
npm run certbot:install
```

---

## Component Management with shadcn

CTS v3.1 uses shadcn/ui components. Add new components using:

```bash
# Add individual components
npx shadcn@latest add button
npx shadcn@latest add card
npx shadcn@latest add dialog

# Add multiple components
npx shadcn@latest add button card dialog input

# List available components
npx shadcn@latest diff
```

### Custom Components

```bash
# Add from v0.dev
npx shadcn@latest add "https://v0.dev/chat/..."

# Add from local file
npx shadcn@latest add ./components/custom-button.tsx
```

---

## Environment Configuration

### Automatic Configuration (via setup script)

The `npm run setup` command automatically:
1. Creates `.env.local` file
2. Generates 32-byte secure secrets
3. Configures database connection
4. Sets project name and port
5. Creates required directories

### Manual Configuration

```bash
# Copy example environment
cp .env.example .env.local

# Edit configuration
nano .env.local
```

**Required Variables:**

```bash
# Application
PROJECT_NAME=CTS-v3
PORT=3000
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development

# Database (choose one)
# Option 1: PostgreSQL
DATABASE_URL=postgresql://user:password@host:5432/database
REMOTE_POSTGRES_URL=postgresql://user:password@host:5432/database

# Option 2: SQLite (auto-created if DATABASE_URL not set)
# SQLITE_DB_PATH=./data/cts.db

# Security (auto-generated by setup)
SESSION_SECRET=your-32-byte-secret
JWT_SECRET=your-32-byte-secret
ENCRYPTION_KEY=your-32-byte-secret
API_SIGNING_SECRET=your-32-byte-secret
```

---

## Multiple Instance Deployment

Deploy multiple CTS instances on different ports:

```bash
# Instance 1: Production
cd cts-prod
PORT=3000 npm run setup
PORT=3000 npm start

# Instance 2: Testing
cd cts-test
PORT=3001 npm run setup
PORT=3001 npm start

# Instance 3: Development
cd cts-dev
PORT=3002 npm run setup
PORT=3002 npm run dev
```

### PM2 Multi-Instance

```bash
# Create PM2 ecosystem file
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'cts-prod',
      script: 'npm',
      args: 'start',
      cwd: '/opt/cts-prod',
      env: { PORT: 3000, NODE_ENV: 'production' }
    },
    {
      name: 'cts-test',
      script: 'npm',
      args: 'start',
      cwd: '/opt/cts-test',
      env: { PORT: 3001, NODE_ENV: 'production' }
    }
  ]
}
EOF

# Start all instances
pm2 start ecosystem.config.js
```

---

## Vercel Deployment

### Via CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Deploy
vercel --prod
```

### Via GitHub Integration

1. Push to GitHub:
```bash
git add .
git commit -m "Deploy CTS v3.1"
git push origin main
```

2. Connect repository in Vercel dashboard
3. Configure environment variables
4. Deploy automatically on push

---

## Troubleshooting

### NPX Issues

```bash
# Clear npm cache
npm cache clean --force

# Verify npx version
npx --version

# Use specific npm registry
npm config set registry https://registry.npmjs.org/
```

### Build Errors

```bash
# Clear all caches
npm run clean:all

# Rebuild node modules
rm -rf node_modules package-lock.json
npm install

# Check TypeScript
npm run type-check
```

### Database Issues

```bash
# Check database status
npm run db:status

# Reset database (caution!)
npm run db:reset

# Check migrations
node scripts/check-db-status.js
```

### Port Conflicts

```bash
# Check what's using port
lsof -i :3000

# Kill process
kill -9 $(lsof -t -i:3000)

# Use different port
PORT=8080 npm run dev
```

---

## Production Checklist

- [ ] Run `npm run setup` with production settings
- [ ] Configure PostgreSQL database
- [ ] Set `NODE_ENV=production`
- [ ] Generate secure secrets (auto-done by setup)
- [ ] Configure nginx reverse proxy
- [ ] Install SSL certificates
- [ ] Setup PM2 for process management
- [ ] Configure firewall (allow ports 80, 443)
- [ ] Setup database backups
- [ ] Configure monitoring
- [ ] Test all exchange connections
- [ ] Verify WebSocket connections

---

## Additional Resources

- [README.md](README.md) - Project overview
- [INSTALL.md](INSTALL.md) - Detailed installation
- [DEPLOYMENT.md](DEPLOYMENT.md) - Deployment options
- [DATABASE_SETUP.md](DATABASE_SETUP.md) - Database configuration
- [BUILD_TROUBLESHOOTING.md](BUILD_TROUBLESHOOTING.md) - Build issues

---

## Support

For issues:
1. Check logs: `npm run nginx:logs` or Settings → Install → Diagnostics
2. System check: `npm run system:check`
3. GitHub issues: https://github.com/your-repo/cts-v3.1/issues
